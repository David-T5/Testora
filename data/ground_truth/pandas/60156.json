{
    "pr_number": 60156,
    "log_file": "60156_2025-10-06 10:18:41.json",
    "differentiating_tests": [
        {
            "test": {
                "test_code": "# Example 2:\n# Large combined label length (sum of many labels > 32,000 chars).\n# Previously this could raise; after the change it should succeed when writing.\nimport io\nimport pandas as pd\n\nprint(\"Example 2: many categories with combined label length > 32000\")\n\n# Build deterministic labels: 500 labels each of length 70 -> 35,000 characters total\nn = 500\nlabel_piece = \"L\" * 70\ncategories = [f\"{label_piece}_{i}\" for i in range(n)]\n# Create a column with all categories used once (deterministic)\ncat = pd.Categorical(categories, categories=categories)\ndf = pd.DataFrame({\"big\": cat})\n\ncombined_len = sum(len(s) for s in categories)\nprint(\"Number of categories:\", n)\nprint(\"Combined label character length:\", combined_len)\n\nbuf = io.BytesIO()\n# Should not raise under the new behavior\ndf.to_stata(buf, write_index=False)",
                "old_output": "  self.warn(\"--include is ignored because --source is set\", slug=\"include-ignored\")\nExample 2: many categories with combined label length > 32000\nNumber of categories: 500\nCombined label character length: 36890\nTraceback (most recent call last):\n  File \"/tmp/Testora/Testora_test_code.py\", line 23, in <module>\n    df.to_stata(buf, write_index=False)\n  File \"/home/pandas/pandas/core/frame.py\", line 2661, in to_stata\n    writer = statawriter(\n             ^^^^^^^^^^^^\n  File \"/home/pandas/pandas/io/stata.py\", line 2423, in __init__\n    self._prepare_pandas(data)\n  File \"/home/pandas/pandas/io/stata.py\", line 2682, in _prepare_pandas\n    data = self._prepare_categoricals(data)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/pandas/pandas/io/stata.py\", line 2492, in _prepare_categoricals\n    svl = StataValueLabel(data[col], encoding=self._encoding)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/pandas/pandas/io/stata.py\", line 661, in __init__\n    self._prepare_value_labels()\n  File \"/home/pandas/pandas/io/stata.py\", line 695, in _prepare_value_labels\n    raise ValueError(\nValueError: Stata value labels for a single variable must have a combined length less than 32,000 characters.\n",
                "new_output": "  self.warn(\"--include is ignored because --source is set\", slug=\"include-ignored\")\nExample 2: many categories with combined label length > 32000\nNumber of categories: 500\nCombined label character length: 36890\n"
            },
            "label": "intended",
            "comment": "label limit of 65534 not exceeded and character length of 32.000 per label is not exceeded."
        },
        {
            "test": {
                "test_code": "# Example 3:\n# One single label longer than 32,000 characters.\nimport io\nimport pandas as pd\n\nprint(\"Example 3: single category label > 32000 chars\")\n\nlong_label = \"X\" * 33000  # single category label whose length exceeds 32k\ncategories = [long_label]\n# Create a categorical column of length 1\ndf = pd.DataFrame({\"longone\": pd.Categorical([long_label], categories=categories)})\n\nprint(\"Single label length:\", len(long_label))\n\nbuf = io.BytesIO()\n# Should succeed now (previously code would raise for combined > 32000)\ndf.to_stata(buf, write_index=False)\nbuf.seek(0)\nprint(\"Wrote bytes length:\", len(buf.getvalue()))\n\n# Attempt to read back (reading could succeed or raise depending on reader support)\nbuf.seek(0)\ntry:\n    df_back = pd.read_stata(buf)\n    print(\"Read back label length:\", len(str(df_back[\"longone\"].iat[0])))\nexcept Exception as e:\n    print(\"Reading back raised:\", repr(e))",
                "old_output": "  self.warn(\"--include is ignored because --source is set\", slug=\"include-ignored\")\nExample 3: single category label > 32000 chars\nSingle label length: 33000\nTraceback (most recent call last):\n  File \"/tmp/Testora/Testora_test_code.py\", line 17, in <module>\n    df.to_stata(buf, write_index=False)\n  File \"/home/pandas/pandas/core/frame.py\", line 2661, in to_stata\n    writer = statawriter(\n             ^^^^^^^^^^^^\n  File \"/home/pandas/pandas/io/stata.py\", line 2423, in __init__\n    self._prepare_pandas(data)\n  File \"/home/pandas/pandas/io/stata.py\", line 2682, in _prepare_pandas\n    data = self._prepare_categoricals(data)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/pandas/pandas/io/stata.py\", line 2492, in _prepare_categoricals\n    svl = StataValueLabel(data[col], encoding=self._encoding)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/pandas/pandas/io/stata.py\", line 661, in __init__\n    self._prepare_value_labels()\n  File \"/home/pandas/pandas/io/stata.py\", line 695, in _prepare_value_labels\n    raise ValueError(\nValueError: Stata value labels for a single variable must have a combined length less than 32,000 characters.\n",
                "new_output": "  self.warn(\"--include is ignored because --source is set\", slug=\"include-ignored\")\nExample 3: single category label > 32000 chars\nSingle label length: 33000\nWrote bytes length: 33373\nRead back label length: 33000\n"
            },
            "label": "unintended",
            "comment": "Single category label length exceeds 32.000, which should raise an error according to https://github.com/pandas-dev/pandas/issues/60107"
        },
        {
            "test": {
                "test_code": "# Example 7:\n# Many small categories (short labels) - combined > 32000\nimport io\nimport pandas as pd\n\nprint(\"Example 7: many small short labels combined > 32000\")\n\n# 5,000 categories each \"Lx\" (2 chars) -> combined length 10000 (not >32000), so pick 20000 categories of \"lab\" (3 chars)\n# For safety in example size, we'll use 15000 categories of 3 chars -> 45000 chars combined\nn = 15000\ncategories = [f\"lab{i}\" for i in range(n)]  # each label deterministic\nprint(\"Number of categories:\", n)\nprint(\"Estimated combined length:\", sum(len(s) for s in categories))\n\ncat = pd.Categorical(categories, categories=categories)\ndf = pd.DataFrame({\"many\": cat})\n\nbuf = io.BytesIO()\ndf.to_stata(buf, write_index=False)",
                "old_output": "  self.warn(\"--include is ignored because --source is set\", slug=\"include-ignored\")\nExample 7: many small short labels combined > 32000\nNumber of categories: 15000\nEstimated combined length: 108890\nTraceback (most recent call last):\n  File \"/tmp/Testora/Testora_test_code.py\", line 19, in <module>\n    df.to_stata(buf, write_index=False)\n  File \"/home/pandas/pandas/core/frame.py\", line 2661, in to_stata\n    writer = statawriter(\n             ^^^^^^^^^^^^\n  File \"/home/pandas/pandas/io/stata.py\", line 2423, in __init__\n    self._prepare_pandas(data)\n  File \"/home/pandas/pandas/io/stata.py\", line 2682, in _prepare_pandas\n    data = self._prepare_categoricals(data)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/pandas/pandas/io/stata.py\", line 2492, in _prepare_categoricals\n    svl = StataValueLabel(data[col], encoding=self._encoding)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/pandas/pandas/io/stata.py\", line 661, in __init__\n    self._prepare_value_labels()\n  File \"/home/pandas/pandas/io/stata.py\", line 695, in _prepare_value_labels\n    raise ValueError(\nValueError: Stata value labels for a single variable must have a combined length less than 32,000 characters.\n",
                "new_output": "  self.warn(\"--include is ignored because --source is set\", slug=\"include-ignored\")\nExample 7: many small short labels combined > 32000\nNumber of categories: 15000\nEstimated combined length: 108890\n"
            },
            "label": "intended",
            "comment": "label limit of 65534 not exceeded and character length of 32.000 per label is not exceeded."
        },
        {
            "test": {
                "test_code": "# Example 16 (corner):\n# Very large number of categories (10,000) with short labels to demonstrate scale.\nimport io\nimport pandas as pd\n\nprint(\"Example 16: 10,000 short categories (scale test)\")\n\nn = 10000\ncategories = [f\"c{i}\" for i in range(n)]\ncat = pd.Categorical(categories, categories=categories)\ndf = pd.DataFrame({\"manyshort\": cat})\n\nprint(\"Number of categories:\", n)\nprint(\"Approx combined char length:\", sum(len(s) for s in categories))\n\nbuf = io.BytesIO()\ndf.to_stata(buf, write_index=False)",
                "old_output": "  self.warn(\"--include is ignored because --source is set\", slug=\"include-ignored\")\nExample 16: 10,000 short categories (scale test)\nNumber of categories: 10000\nApprox combined char length: 48890\nTraceback (most recent call last):\n  File \"/tmp/Testora/Testora_test_code.py\", line 17, in <module>\n    df.to_stata(buf, write_index=False)\n  File \"/home/pandas/pandas/core/frame.py\", line 2661, in to_stata\n    writer = statawriter(\n             ^^^^^^^^^^^^\n  File \"/home/pandas/pandas/io/stata.py\", line 2423, in __init__\n    self._prepare_pandas(data)\n  File \"/home/pandas/pandas/io/stata.py\", line 2682, in _prepare_pandas\n    data = self._prepare_categoricals(data)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/pandas/pandas/io/stata.py\", line 2492, in _prepare_categoricals\n    svl = StataValueLabel(data[col], encoding=self._encoding)\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/pandas/pandas/io/stata.py\", line 661, in __init__\n    self._prepare_value_labels()\n  File \"/home/pandas/pandas/io/stata.py\", line 695, in _prepare_value_labels\n    raise ValueError(\nValueError: Stata value labels for a single variable must have a combined length less than 32,000 characters.\n",
                "new_output": "  self.warn(\"--include is ignored because --source is set\", slug=\"include-ignored\")\nExample 16: 10,000 short categories (scale test)\nNumber of categories: 10000\nApprox combined char length: 48890\n"
            },
            "label": "intended",
            "comment": "label limit of 65534 not exceeded and character length of 32.000 per label is not exceeded."
        },
        {
            "test": {
                "test_code": "# Example 20 (corner):\n# Try writing the same large-label DataFrame with two different Stata format versions.\nimport io\nimport pandas as pd\n\nprint(\"Example 20: write with different Stata versions (format differences)\")\n\n# Make a moderate large label set ( > 32000 )\nn = 800\npiece = \"X\" * 50\ncategories = [f\"{piece}_{i}\" for i in range(n)]\ncombined_len = sum(len(s) for s in categories)\nprint(\"Combined char length:\", combined_len)\n\ndf = pd.DataFrame({\"v\": pd.Categorical(categories, categories=categories)})\n\nfor ver in (114, 117):\n    buf = io.BytesIO()\n    try:\n        df.to_stata(buf, write_index=False, version=ver)\n        print(f\"Version {ver}: wrote bytes length {len(buf.getvalue())}\")\n    except Exception as e:\n        print(f\"Version {ver}: writing raised {repr(e)}\")",
                "old_output": "  self.warn(\"--include is ignored because --source is set\", slug=\"include-ignored\")\nExample 20: write with different Stata versions (format differences)\nCombined char length: 43090\nVersion 114: writing raised ValueError('Stata value labels for a single variable must have a combined length less than 32,000 characters.')\nVersion 117: writing raised ValueError('Stata value labels for a single variable must have a combined length less than 32,000 characters.')\n",
                "new_output": "  self.warn(\"--include is ignored because --source is set\", slug=\"include-ignored\")\nExample 20: write with different Stata versions (format differences)\nCombined char length: 43090\nVersion 114: wrote bytes length 52253\nVersion 117: wrote bytes length 52699\n"
            },
            "label": "intended",
            "comment": "label limit of 65534 not exceeded and character length of 32.000 per label is not exceeded."
        }
    ]
}